<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/css/styles.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>Comics</title>
</head>
<body>
<!-- Button to create a new comic -->
<button onclick="redirectToCreateComic()">Create New Comic</button>

<!-- Search Form -->
<form id="search-form">
    <label for="search">Search by Title:</label>
    <input type="text" id="search" name="search">
    <button type="submit">Search</button>
</form>

<!-- Table of Comics -->
<table id="comics-table">
    <thead>
    <tr>
        <th>Cover Image</th>
        <th>Title</th>
        <th>Description</th>
        <th>Status</th>
        <th>Genres</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody id="comics-table-body">
    <!-- Iterate through comics and display each comic -->

    </tbody>
</table>

<!-- Script to handle AJAX requests -->

<script>

    $(document).ready(function() {
        loadComics();

        // Search form submit event
        $('#search-form').submit(function(event) {
            event.preventDefault();
            var searchValue = $('#search').val();
            searchComics(searchValue);
        });
    });

    function loadComics() {
        $.ajax({
            url: 'http://localhost:8080/api/comics',
            type: 'GET',
            success: function(data) {
                displayComics(data);

            },
            error: function(xhr, textStatus, errorThrown) {
                console.log(xhr.responseText);
            }
        });
    }

    function displayComics(comics) {
        console.log('Displaying comics:', comics);
        var tableBody = $('#comics-table-body');
        tableBody.empty();

        comics.forEach(function(comic) {
            var row = $('<tr></tr>');

            var coverImageCell = $('<td></td>');
            var coverImage = $('<img>');
            coverImage.attr('src', comic.coverImage);
            coverImage.attr('width', '100');
            coverImage.attr('height', '100');
            coverImage.attr('alt', 'Comic Cover Image');
            coverImageCell.append(coverImage);
            row.append(coverImageCell);

            var titleCell = $('<td></td>');
            titleCell.text(comic.title);
            row.append(titleCell);

            var descriptionCell = $('<td></td>');
            descriptionCell.text(comic.description);
            row.append(descriptionCell);

            var statusCell = $('<td></td>');
            statusCell.text(comic.status);
            row.append(statusCell);

            var genresCell = $('<td></td>');

            var genresList = $('<ul></ul>');

            // Kiểm tra nếu comic.genres là một mảng và có ít nhất một phần tử
            if (Array.isArray(comic.genres) && comic.genres.length > 0) {
                comic.genres.forEach(function(genre) {
                    var genresItem = $('<li></li>');
                    genresItem.text(genre.name);
                    genresList.append(genresItem);
                });
            } else {
                var noGenres = $('<li>No genres available</li>');
                genresList.append(noGenres);
            }

            genresCell.append(genresList);
            row.append(genresCell);

            var actionsCell = $('<td></td>');

            var editButton = $('<button></button>');
            editButton.text('Edit');
            editButton.on('click', function() {
                editComic(comic.id);
            });

            var deleteButton = $('<button></button>');
            deleteButton.text('Delete');
            deleteButton.on('click', function() {
                deleteComic(comic.id);
            });

            actionsCell.append(editButton);
            actionsCell.append(deleteButton);
            row.append(actionsCell);

            tableBody.append(row);
        });
    }


    function editComic(comicId) {
        // Redirect to edit-comic.html with comicId as parameter
        window.location.href = '/admin/edit-comic.html?id=' + comicId;
    }

    function deleteComic(comicId) {
        if (confirm('Are you sure you want to delete this comic?')) {
            $.ajax({
                url: 'http://localhost:8080/api/comics/delete/' + comicId,
                type: 'DELETE',
                success: function(data) {
                    alert('Comic deleted successfully!');
                    loadComics();
                },
                error: function(xhr, textStatus, errorThrown) {
                    console.log(xhr.responseText);
                    alert('Error deleting comic. Please try again.');
                }
            });
        }
    }

    function redirectToCreateComic() {
        // Redirect to create-comic.html
        window.location.href = '/admin/create-comic.html';
    }
</script>
</body>
</html>
